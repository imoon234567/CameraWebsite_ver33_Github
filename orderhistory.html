<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order History • GreatestCameraLover</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"/>
  <link rel="stylesheet" href="style.css"/>
  <!-- Google Identity Services (needed for Account modal) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    /* tiny helpers so this page looks good even if style.css changes */
    .Order_Items{ margin-top:8px; display:flex; flex-direction:column; gap:8px; }
    .Order_Line{ display:flex; align-items:center; gap:10px; }
    .Order_Line img{ width:90px; height:60px; object-fit:cover; border-radius:6px; border:1px solid #eee; }
    .Order_Line .meta{ color:#666; font-size:.92rem; }
  </style>
</head>
<body>
<header>
  <nav class="Navigation_bar">
    <a href="index.html" class="Navigation_Logo">
      <img src="images/grell.webp" alt="Nikon Logo" width="50" height="50">
    </a>
    <div class="Navigation_Inner Section_content">
      <ul class="Navigation_Menu">
        <button id="Menu_Close_Button" class="fas fa-times"></button>

        <!-- Search bar (now visible & consistent with other pages) -->
        <li class="Navigation_Item Navigation_Search_Bar">
          <form id="Navigation_Search_Form" role="search" action="#menu">
            <input id="Navigation_Search_Input" class="Navigation_Search_Input" type="search" placeholder="Search menu..." aria-label="Search menu">
            <button class="Navigation_Search_Button" type="submit" aria-label="Search">
              <i class="fa-solid fa-magnifying-glass"></i>
            </button>
          </form>
        </li>

        <li class="Navigation_Item"><a href="index.html" class="nav-link">Home</a></li>
        <li class="Navigation_Item"><a href="catalog.html" class="nav-link">Catalog</a></li>
        <li class="Navigation_Item"><a href="wishlist.html" class="nav-link">Wishlist</a></li>
        <li class="Navigation_Item"><a href="index.html#contact" class="nav-link">Support</a></li>
        <li class="Navigation_Item"><a href="cart.html" class="nav-link">My Cart</a></li>
        <li class="Navigation_Item"><a href="#Account" class="nav-link" id="Open_Account">Account</a></li>
      </ul>
      <button id="Menu_Open_Button" class="fas fa-bars"></button>
    </div>
  </nav>
</header>

<main>
  <section class="Cart_Section">
    <div class="Section_content">
      <h2 class="section-title">Order History</h2>
      <ul id="Orders_List" class="Cart_List"></ul>
    </div>
  </section>
</main>

<!-- ===== Auth Modal (same as other pages) ===== -->
<div id="Auth_Modal" class="auth-modal" aria-hidden="true">
  <div class="auth-dialog" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <button class="auth-close" aria-label="Close">&times;</button>
    <h3 id="authTitle" class="auth-title">Welcome</h3>
    <div class="auth-tabs" role="tablist">
      <button class="auth-tab is-active" data-tab="login" role="tab" aria-selected="true">Log in</button>
      <button class="auth-tab" data-tab="signup" role="tab" aria-selected="false">Sign up</button>
    </div>
    <form id="Login_Form" class="auth-panel" data-panel="login" autocomplete="on">
      <label class="auth-label">Username or email <input class="auth-input" type="text" name="username" required /></label>
      <label class="auth-label">Password <input class="auth-input" type="password" name="password" required /></label>
      <button class="auth-submit" type="submit">Log in</button>
      <p class="auth-msg" id="loginMsg" role="alert"></p>
    </form>
    <form id="Signup_Form" class="auth-panel is-hidden" data-panel="signup" autocomplete="on">
      <label class="auth-label">Username <input class="auth-input" type="text" name="username" required /></label>
      <label class="auth-label">Password <input class="auth-input" type="password" name="password" minlength="6" required /></label>
      <button class="auth-submit" type="submit">Sign up</button>
      <p class="auth-msg" id="signupMsg" role="alert"></p>
    </form>
    <div class="auth-or"><span>or</span></div>
    <div id="g_id_onload" data-client_id="REPLACE_WITH_YOUR_GOOGLE_CLIENT_ID" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
    <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="continue_with" data-shape="rectangular" data-logo_alignment="left"></div>
  </div>
</div>

<!-- Helpers & DB hydration (ORDER MATTERS) -->
<script src="products.js?v=2"></script>
<script>window.DB_API_BASE = 'http://localhost/CameraWebsite_ver33_Github/api';</script>
<script src="db-client.js?v=5"></script>
<script src="script.js?v=2"></script>

<!-- Page logic -->
<script>
(function(){
  const API_BASE = (window.DB_API_BASE || 'api').replace(/\/$/, '');
  const list = document.getElementById('Orders_List');

  const currentUser = localStorage.getItem('currentUser') || '';
  if (!currentUser) {
    alert('Please log in to view your order history.');
    window.location.href = 'index.html';
    return;
  }
  // Show username on Account pill
  const accBtn = document.getElementById('Open_Account');
  if (accBtn) accBtn.textContent = currentUser;

  function h(el, html){ el.innerHTML = html; return el; }
  function fmt(n, cur){ return (typeof formatPrice === 'function') ? formatPrice(n, cur) : ('$' + Number(n).toFixed(2)); }
  function safe(s){ return String(s||''); }

  async function loadOrders(){
    try{
      list.innerHTML = '<li class="Cart_Empty">Loading orders…</li>';
      const url = `${API_BASE}/orders_list.php?user=${encodeURIComponent(currentUser)}&_=${Date.now()}`;
      const res = await fetch(url, { cache:'no-store' });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'Failed to load');

      const orders = json.data || [];
      if (!orders.length){
        list.innerHTML = '<li class="Cart_Empty">You have no orders yet.</li>';
        return;
      }
      list.innerHTML = '';
      orders.forEach(o => {
        const itemsHTML = (o.items||[]).map(it => {
          const lineTotal = (Number(it.unit_price)||0) * (Number(it.qty)||0);
          return `
            <li class="Order_Line">
              <img src="${safe(it.img)}" alt="">
              <div>
                <div><strong>${safe(it.name)}</strong></div>
                <div class="meta">x${it.qty} @ ${fmt(it.unit_price, o.currency)} = <strong>${fmt(lineTotal, o.currency)}</strong></div>
              </div>
            </li>`;
        }).join('');

        const li = document.createElement('li');
        li.className = 'Cart_Item';
        li.innerHTML = `
          <div class="Cart_Left">
            <div class="Cart_Info">
              <h3 class="Cart_Title">Order #${o.id}</h3>
              <div class="Cart_Meta">Placed on ${new Date(o.created_at).toLocaleString()}</div>
              <ul class="Order_Items">${itemsHTML}</ul>
            </div>
          </div>
          <div class="Cart_Right">
            <div class="Cart_LineTotal">${fmt(o.total, o.currency)}</div>
          </div>
        `;
        list.appendChild(li);
      });
    }catch(e){
      console.error(e);
      list.innerHTML = '<li class="Cart_Empty">Could not load orders.</li>';
    }
  }

  loadOrders();
})();
</script>
</body>
</html>
