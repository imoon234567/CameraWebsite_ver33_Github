<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>My Cart • GreatestCameraLover</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"/>
    <link rel="stylesheet" href="style.css"/>

    <!-- Google Identity Services (needed for Account modal) -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>

  <body>
    <!-- Header / Navigation -->
    <header>
      <nav class="Navigation_bar">
        <a href="index.html" class="Navigation_Logo">
          <img src="images/grell.webp" alt="Nikon Logo" width="50" height="50">
        </a>

        <div class="Navigation_Inner Section_content">
          <ul class="Navigation_Menu">
            <button id="Menu_Close_Button" class="fas fa-times" aria-label="Close menu"></button>

            <!-- Search bar (made visible + matches other pages) -->
            <li class="Navigation_Item Navigation_Search_Bar">
              <form id="Navigation_Search_Form" role="search" action="#menu">
                <input id="Navigation_Search_Input" class="Navigation_Search_Input" type="search" placeholder="Search menu..." aria-label="Search menu">
                <button class="Navigation_Search_Button" type="submit" aria-label="Search">
                  <i class="fa-solid fa-magnifying-glass"></i>
                </button>
              </form>
            </li>

            <li class="Navigation_Item"><a href="index.html" class="nav-link">Home</a></li>
            <li class="Navigation_Item"><a href="catalog.html" class="nav-link">Catalog</a></li>
            <li class="Navigation_Item"><a href="wishlist.html" class="nav-link">Wishlist</a></li>
            <li class="Navigation_Item"><a href="index.html#contact" class="nav-link">Support</a></li>
            <li class="Navigation_Item"><a href="cart.html" class="nav-link">My Cart</a></li>
            <li class="Navigation_Item"><a href="#Account" class="nav-link" id="Open_Account">Account</a></li>
          </ul>

          <button id="Menu_Open_Button" class="fas fa-bars" aria-label="Open menu"></button>
        </div>
      </nav>
    </header>

    <main>
      <section class="Cart_Section">
        <div class="Section_content">
          <h2 class="section-title">My Cart</h2>

          <ul id="Cart_List" class="Cart_List"></ul>

          <div class="Cart_TotalBar">
            <button id="Cart_Clear" class="Cart_Clear">Clear cart</button>
            <button id="Cart_Buy" class="Cart_Clear" style="background:var(--Epic-Yellow-color); border-color:var(--Epic-Yellow-color); font-weight:700;">
              <i class="fa-solid fa-bag-shopping"></i> Buy
            </button>
            <div id="Cart_Total" class="Cart_Total"></div>
          </div>
        </div>
      </section>
    </main>

    <!-- ===== Auth Modal (same as index) ===== -->
    <div id="Auth_Modal" class="auth-modal" aria-hidden="true">
      <div class="auth-dialog" role="dialog" aria-modal="true" aria-labelledby="authTitle">
        <button class="auth-close" aria-label="Close">&times;</button>

        <h3 id="authTitle" class="auth-title">Welcome</h3>

        <div class="auth-tabs" role="tablist">
          <button class="auth-tab is-active" data-tab="login" role="tab" aria-selected="true">Log in</button>
          <button class="auth-tab" data-tab="signup" role="tab" aria-selected="false">Sign up</button>
        </div>

        <form id="Login_Form" class="auth-panel" data-panel="login" autocomplete="on">
          <label class="auth-label">Username or email
            <input class="auth-input" type="text" name="username" required />
          </label>
          <label class="auth-label">Password
            <input class="auth-input" type="password" name="password" required />
          </label>
          <button class="auth-submit" type="submit">Log in</button>
          <p class="auth-msg" id="loginMsg" role="alert"></p>
        </form>

        <form id="Signup_Form" class="auth-panel is-hidden" data-panel="signup" autocomplete="on">
          <label class="auth-label">Username
            <input class="auth-input" type="text" name="username" required />
          </label>
          <label class="auth-label">Password
            <input class="auth-input" type="password" name="password" minlength="6" required />
          </label>
          <button class="auth-submit" type="submit">Sign up</button>
          <p class="auth-msg" id="signupMsg" role="alert"></p>
        </form>

        <div class="auth-or"><span>or</span></div>

        <div id="g_id_onload"
          data-client_id="REPLACE_WITH_YOUR_GOOGLE_CLIENT_ID"
          data-callback="handleCredentialResponse"
          data-auto_prompt="false"></div>
        <div class="g_id_signin"
          data-type="standard"
          data-size="large"
          data-theme="outline"
          data-text="continue_with"
          data-shape="rectangular"
          data-logo_alignment="left"></div>
      </div>
    </div>

    <!-- Helpers & DB hydration (ORDER MATTERS) -->
    <script src="products.js?v=2"></script>
    <script>window.DB_API_BASE = 'http://localhost/CameraWebsite_ver33_Github/api';</script>
    <script src="db-client.js?v=5"></script>
    <script src="script.js?v=2"></script>

    <!-- Cart page logic -->
    <script>
      // Cart helpers
      function getCart(){ try { return JSON.parse(localStorage.getItem('cart') || '[]'); } catch { return []; } }
      function setCart(c){ localStorage.setItem('cart', JSON.stringify(c)); }
      function num(n){ const v = Number(n); return Number.isFinite(v) ? v : 0; }

      // Render cart
      function renderCart(){
        const list = document.getElementById('Cart_List');
        const totalEl = document.getElementById('Cart_Total');
        const clearBtn = document.getElementById('Cart_Clear');
        const buyBtn = document.getElementById('Cart_Buy');

        // ensure prices if missing (look up by id in PRODUCTS)
        let cart = getCart();
        let touched = false;
        if (Array.isArray(window.PRODUCTS)) {
          cart.forEach(it => {
            if (it.price == null) {
              const found = window.PRODUCTS.find(p => p.id === it.id || p.name === it.name);
              if (found && found.price != null) { it.price = Number(found.price); touched = true; }
            }
          });
          if (touched) { setCart(cart); }
        }

        if (!cart.length){
          list.innerHTML = `<li class="Cart_Empty">Your cart is empty.</li>`;
          totalEl.textContent = '';
          clearBtn.disabled = true;
          buyBtn.disabled = true;
          return;
        }

        clearBtn.disabled = false;
        buyBtn.disabled = false;
        list.innerHTML = '';
        let total = 0;

        cart.forEach(item => {
          const qty = num(item.qty) || 1;
          const unit = num(item.price);
          const lineTotal = unit * qty;
          total += lineTotal;

          const li = document.createElement('li');
          li.className = 'Cart_Item';
          li.innerHTML = `
          <div class="Cart_Left">
            <img class="Cart_Thumb" src="${item.img}" alt="${item.name}">
            <div class="Cart_Info">
              <h3 class="Cart_Title">${item.name}</h3>
              <div class="Cart_Meta">Added on ${new Date(item.addedAt||Date.now()).toLocaleDateString()}</div>
              <div class="Cart_Controls">
                <button class="qty dec" aria-label="Decrease quantity">−</button>
                <span class="qty-val">${qty}</span>
                <button class="qty inc" aria-label="Increase quantity">+</button>
                <button class="remove">Remove</button>
              </div>
            </div>
          </div>
          <div class="Cart_Right">
            <div class="Cart_LineTotal">${typeof formatPrice==='function' ? formatPrice(lineTotal) : ('$'+lineTotal)}</div>
          </div>
          `;

          list.appendChild(li);

          // Controls
          li.querySelector('.remove').addEventListener('click', () => {
            setCart(getCart().filter(x => x.id !== item.id));
            renderCart();
          });
          li.querySelector('.inc').addEventListener('click', () => {
            const c = getCart(); const t = c.find(x => x.id === item.id);
            t.qty = num(t.qty) + 1; setCart(c); renderCart();
          });
          li.querySelector('.dec').addEventListener('click', () => {
            const c = getCart(); const t = c.find(x => x.id === item.id);
            t.qty = num(t.qty) - 1;
            if (t.qty <= 0) setCart(c.filter(x => x.id !== item.id));
            else setCart(c);
            renderCart();
          });
        });

        totalEl.innerHTML = `<strong>Total:</strong> ${typeof formatPrice==='function' ? formatPrice(total) : ('$'+total)}`;

        // Buy handler (save to Order_history DB)
        buyBtn.onclick = async () => {
          const current = getCart();
          const grandTotal = current.reduce((s,i) => s + (num(i.price) * (num(i.qty)||1)), 0);
          if (!current.length) return;

          const user = localStorage.getItem('currentUser') || '';
          if (!user) {
            alert('Please log in first.');
            document.getElementById('Open_Account')?.click();
            return;
          }

          const confirmed = confirm(`Buy ${current.length} item(s) for ${typeof formatPrice==='function' ? formatPrice(grandTotal) : ('$'+grandTotal)}?`);
          if (!confirmed) return;

          const items = current.map(it => ({
            id: it.id,
            name: it.name,
            qty: num(it.qty) || 1,
            price: num(it.price) || 0,
            img: it.img || ''
          }));

          try{
            const API_BASE = (window.DB_API_BASE || 'api').replace(/\/$/, '');
            const res = await fetch(`${API_BASE}/order_create.php`, {
              method: 'POST',
              headers: { 'Content-Type':'application/json' },
              body: JSON.stringify({ user, items, currency: 'USD' })
            });
            const json = await res.json();
            if (!json.ok) throw new Error(json.error || 'Order failed');

            localStorage.removeItem('cart');
            alert(`Thanks for your purchase! Order #${json.data.order_id} created.`);
            window.location.href = 'orderhistory.html';
          }catch(err){
            console.error(err);
            alert('Sorry, we could not create your order.');
          }finally{
            renderCart();
          }
        };
      }

      // Clear cart
      document.getElementById('Cart_Clear').addEventListener('click', () => {
        if (confirm('Clear all items from cart?')) {
          localStorage.removeItem('cart');
          renderCart();
        }
      });

      document.addEventListener('DOMContentLoaded', renderCart);
    </script>
  </body>
</html>
